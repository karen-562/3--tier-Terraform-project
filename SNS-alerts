# CloudWatch + SNS Alerts
# ---------------------------
resource "aws_sns_topic" "alerts" {
name = "${var.project}-alerts"
}


resource "aws_sns_topic_subscription" "email" {
count = length(var.alert_emails)
topic_arn = aws_sns_topic.alerts.arn
protocol = "email"
endpoint = var.alert_emails[count.index]
}


# ALB 5XX alarm
resource "aws_cloudwatch_metric_alarm" "alb_5xx" {
alarm_name = "${var.project}-alb-5xx"
comparison_operator = "GreaterThanThreshold"
evaluation_periods = 1
metric_name = "HTTPCode_ELB_5XX_Count"
namespace = "AWS/ApplicationELB"
period = 60
statistic = "Sum"
threshold = 5
dimensions = {
LoadBalancer = aws_lb.alb.arn_suffix
}
alarm_description = "5xx errors on ALB"
alarm_actions = [aws_sns_topic.alerts.arn]
}


# ASG CPU High alarm
resource "aws_cloudwatch_metric_alarm" "asg_cpu_high" {
alarm_name = "${var.project}-asg-cpu-high"
comparison_operator = "GreaterThanThreshold"
evaluation_periods = 2
metric_name = "CPUUtilization"
namespace = "AWS/EC2"
period = 60
statistic = "Average"
threshold = 70
dimensions = {
AutoScalingGroupName = aws_autoscaling_group.app_asg.name
}
alarm_description = "High CPU on ASG"
alarm_actions = [aws_sns_topic.alerts.arn]
}


# RDS CPU alarm
resource "aws_cloudwatch_metric_alarm" "rds_cpu_high" {
count = var.create_rds ? 1 : 0
alarm_name = "${var.project}-rds-cpu-high"
comparison_operator = "GreaterThanThreshold"
evaluation_periods = 2
metric_name = "CPUUtilization"
namespace = "AWS/RDS"
period = 60
statistic = "Average"
threshold = 70
dimensions = {
DBInstanceIdentifier = aws_db_instance.mysql[0].id
}
alarm_description = "High RDS CPU"
alarm_actions = [aws_sns_topic.alerts.arn]
}
